name: CI

on: [push]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  debian-example-image:
    name: Debian example image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install git build-essential gcc pkg-config cmake python3
          # enable additional features
          sudo apt-get install cmake-curses-gui     # for the ccmake graphical interface
          sudo apt-get install libmbedtls-dev       # for encryption support
          sudo apt-get install check libsubunit-dev # for unit tests
          sudo apt-get install python3-sphinx graphviz  # for documentation generation
          sudo apt-get install python3-sphinx-rtd-theme # documentation style
      - name: Build open62541
        run: |
          cd ${WORKDIR}/git
          cmake --build .  
      - name: Free Disk Space
        uses: ./.github/workflows/free-disk-space
      - name: Build image
        run: ./kas-container build kas-iot2050-example.yml
      - name: Upload image
        uses: actions/upload-artifact@v4
        with:
          name: iot2050-example-image
          path: |
            build/tmp/deploy/images/iot2050/iot2050-image-example-iot2050-debian-iot2050.wic
            build/tmp/deploy/images/iot2050/iot2050-image-example-iot2050-debian-iot2050.wic.bmap
